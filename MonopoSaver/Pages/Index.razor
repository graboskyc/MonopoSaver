@page "/{Token}"
@page "/"
@inject IJSRuntime JSRuntime;
@inject NavigationManager NavigationManager;
@using HeyRed.MarkdownSharp;
@using MongoDB.Bson;
@using MongoDB.Driver;
@inject IMongoCollection<Game> GCol;

<PageTitle>Monopo Saver</PageTitle>

@if(_showModal) {
    <dialog open>
        <article>
            <header>
            <button aria-label="Close" @onclick="ToggleRules"></button>
            <p>
                <strong>Rules</strong>
            </p>
            </header>
            @Rules
        </article>
    </dialog>
}
 
@if(g != null) {
    <article>
        <header>
            <h1>Monopo Saver</h1>
        </header>

        <h3><i>Game Code <b @onclick="CopyToClipboard">@g.Token</b></i></h3>
        <h3>Board Variant <select @onchange="VariantChanged" class="form-control">
            <option value="GB">GB</option>
            <option value="Cat">Cat</option>
            <option class="original">Original</option>
        </select></h3>
    </article>

    <EditForm Model="@g">

        @foreach (var p in g.Players)
        {
            <article>
                <header data-theme="dark">
                    <h2>Player <input type="text" @bind="p.Name" class="form-control" /></h2>
                </header>            

                <table>
                    <tr><th>Piece</th>
                        <td><select @bind="p.GamePiece" class="form-control">
                            @foreach (var piece in b.Pieces)
                            {
                                <option>@piece</option>
                            }
                            </select></td></tr>
                    <tr><th>Position</th>
                        <td><select @bind="p.LastPosition" class="form-control">
                            @foreach (var card in b.Places)
                            {
                                <option>@card.Name</option>
                            }
                            </select></td></tr>
                    <tr><th>Money</th>
                        <td><div class="input-group"><div class="input-group-prepend">
                            <div class="input-group-text">$</div></div>
                            <input class="form-control" type="number" @bind="p.Money" /></div></td></tr>
                    <tr><th>Get Out Of Jail Cards</th>
                        <td><input class="form-control" type="number" min="0" max="10" @bind="p.GetOutOfJailCards" /></td></tr>
                </table>

                <article>
                    <header><h3 class="card-title">@p.Name's Properties:</h3></header>

                        <table class="striped" style="margin:5px;">
                            <thead data-theme="dark"><tr>
                                <th></th>
                                <th>Name</th>
                                <th>House</th>
                                <th>Mort.</th>
                            </tr></thead>
                            <tbody>
                                @foreach (var c in p.Props) {
                                    <tr>
                                        <td>
                                            <button class="secondary" @onclick="(() => DelProp(p, c))" style="border: var(--pico-del-color); background-color: var(--pico-del-color);"><span class="material-symbols-outlined">delete</span></button>
                                            </td>
                                        <td><select @bind="c.Name" class="form-control" style="border-width:3px; border-color:@(b.Places.Where(p=> p.Name == c.Name).FirstOrDefault()?.Color ?? "#000000") ">
                                            @foreach (var group in b.Places.Where(card => card.Ownable == true ).GroupBy(card => card.ColorName))
                                            {
                                                <optgroup label="@group.Key">
                                                @foreach (var card in group)
                                                {
                                                    <option>@card.Name</option>
                                                }
                                                </optgroup>
                                            }
                                            </select></td>
                                        <td><select @bind="c.Houses" class="form-control">
                                            <option value="0">None</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">Hotel</option>
                                        </select></td>
                                        <td><select @bind="c.isMortgaged" class="form-control">
                                            <option value="0">No</option>
                                            <option value="1">Yes</option>
                                        </select></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <footer>
                            <button @onclick="@(() => AddProp(p))" class="secondary" style="width: 100%;">Add Propery</button>
                        </footer>
                </article>
            </article>
        }
    </EditForm>

    <br><br>

    <div>@resp</div>
    <button @onclick="AddPlayer" class="secondary" style="width: 100%; margin: .25rem;">Add Player</button>
    <br>
    <button @onclick="Save" class="btn btn-lg btn-gsky-pri" style="width: 100%; margin: .25rem;">Save With New ID</button>
    <br>
    <button @onclick="(() => ToggleRules())" class="outline" style="width: 100%; margin: .25rem;">Show Rules</button>

    <br><br>
}


@code {
    [Parameter]
    public string Token {get; set;}

    DataModels.Game g = null;
    DataModels.Board b = null;
    string BoardVariant = "GB";
    string resp = "";
    private MarkupString Rules;
    Markdown mark = new Markdown();
    
    private bool _showModal = false;

    private void ToggleRules() {
        _showModal = !_showModal;
    }

    private string NewSaveToken() {
        Random random = new Random();
        const string chars = "AaBbCcDdEeFfGgHhLMmNnQqRrYy23456789";
        return new string(Enumerable.Repeat(chars, 6).Select(s => s[random.Next(s.Length)]).ToArray());
   }

   private void AddPlayer() {
       g.Players.Add(new DataModels.Player());
       StateHasChanged();
   }

   private void AddProp(DataModels.Player p) {
       p.Props.Add(new DataModels.Prop());
       StateHasChanged();
   }

   private void DelProp(DataModels.Player p, DataModels.Prop c) {
       p.Props.RemoveAll(card => card.Name == c.Name);
       StateHasChanged();
   }

   private async Task Save() {
       Token = NewSaveToken();
       g.Token = Token;
       StateHasChanged();
       var filter = Builders<DataModels.Game>.Filter.Eq(x => x.Token, g.Token);
       var options = new ReplaceOptions { IsUpsert = true };
       GCol.ReplaceOne(filter, g, options);
       NavigationManager.NavigateTo("/"+Token);
   }

    private void VariantChanged(ChangeEventArgs e) {
        BoardVariant = e.Value.ToString();
        b = new DataModels.Board(BoardVariant);
        Rules = (MarkupString)mark.Transform(b.Rules);
        StateHasChanged();
    }

    private async Task CopyToClipboard()
    {
        await JSRuntime.InvokeVoidAsync("copyToClipboard", g.Token);
    }

    protected override async Task OnInitializedAsync() {
        if (Token == null) {
            Token = NewSaveToken();
            NavigationManager.NavigateTo("/"+Token);
        }

        b = new DataModels.Board(BoardVariant);
        Rules = (MarkupString)mark.Transform(b.Rules);

        var loadedGame = GCol.Find(x => x.Token == Token).FirstOrDefault();

        if(loadedGame != null) {
            g = loadedGame;
        } else {
            g = new DataModels.Game();
            g.Token = Token;
        }

        StateHasChanged();
    }
}